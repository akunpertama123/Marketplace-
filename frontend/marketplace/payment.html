<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payment - Template Marketplace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            padding: 2rem;
            text-align: center;
        }
        .qr-code {
            margin: 2rem auto;
            width: 200px;
            height: 200px;
            background-size: cover;
            background-position: center;
        }
        .payment-details {
            margin: 2rem auto;
            max-width: 400px;
            text-align: left;
        }
        #paymentStatus {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 5px;
            display: none;
        }
        .payment-section {
            display: none;
        }
        .payment-section.active {
            display: block;
        }
        .btn-download-green {
            background-color: #28a745;
            color: white;
            border: none;
            margin-right: 10px;
            padding: 6px 12px;
            cursor: pointer;
        }
        .btn-download-red {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
        }
        /* Center images container inside card body */
        #downloadList {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        #downloadList .card {
            width: 300px;
            text-align: center;
        }
        #downloadList .card > .card-body > div {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        #downloadList img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid #ccc;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <h1>Payment</h1>
    
    <!-- QR Code Payment -->
    <div id="qrSection" class="payment-section active">
        <div class="payment-details mb-4" style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Total Pembayaran <span id="totalAmount" style="font-weight: bold;"></span></h3>
        </div>
        <div id="paymentQRContainer" class="text-center">
            <p class="mb-4">Scan QR code below using Dana</p>
            <img src="../assets/qr-gopay.jpg" alt="Payment QR Code" style="width: 300px; height: 300px; margin: 0 auto;">
            <div class="mt-4">
                <p class="mb-1 fw-bold">Nadia Fitria R</p>
                <p class="text-muted">+62 857 **** 3269</p>
            </div>
            <button id="payNowBtn" class="btn btn-primary btn-lg mt-4">Pay Now</button>
        </div>
    </div>

    <!-- Waiting for Confirmation -->
    <div id="waitingSection" class="payment-section">
    <div id="paymentStatus" class="alert alert-info" style="display:none;">
        Menunggu Konfirmasi Pembayaran
    </div>
    <div id="paymentMessage" class="alert alert-success" style="display:none;"></div>
    </div>

    <!-- Success View -->
    <div id="successSection" class="payment-section">
        <div id="downloadSection">
            <h3>Your Templates</h3>
            <div id="downloadList" class="mb-3"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Check authentication
        const currentUser = checkAuth();
        if (!currentUser) {
            window.location.href = '../index.html';
        }

let cartItems = JSON.parse(sessionStorage.getItem('selectedTemplatesForDownload')) || [];
if (cartItems.length === 0) {
    window.location.href = 'cart.html';
} else {
    // Normalize cart items to add samplePreviewUrls if missing
    cartItems = cartItems.map(item => {
        if (!item.samplePreviewUrls && item.samplePreviewPaths) {
            return {
                ...item,
                samplePreviewUrls: item.samplePreviewPaths.map(p => '/uploads/' + p.split(/[\\/]/).pop())
            };
        }
        return item;
    });
    sessionStorage.setItem('selectedTemplatesForDownload', JSON.stringify(cartItems));
}

        let paymentId = null;

        // Display order summary
        function displayOrderSummary() {
            const totalAmount = document.getElementById('totalAmount');
            let total = 0;

            cartItems.forEach(item => {
                const price = typeof item.price === 'number' && item.price >= 0 ? item.price : 0;
                total += price;
            });

            totalAmount.textContent = `Rp ${total.toLocaleString()}`;
        }

        // Show QR code and create payment record
        function showQRCode() {
        console.log('Creating payments for cart items:', cartItems);  // Added log
        // Create payment records in backend, one per template
        Promise.all(cartItems.map(item => {
            console.log('Creating payment for item:', item);  // Added log
            return fetch('/api/payments/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    templateId: item.id,
                    buyerId: currentUser.email,
                    price: item.price
                })
            }).then(res => res.json());
        })).then(results => {
            console.log('Payment creation results:', results);  // Added log
            const error = results.find(r => r.error);
            if (error) {
                alert('Error creating payment: ' + error.error);
                return;
            }
            // Set paymentId from first result (assuming one payment per purchase)
            paymentId = results[0]?.id || null;

            // Show payment processed message in page
            const paymentMessage = document.getElementById('paymentMessage');
            paymentMessage.textContent = 'Pembayaran diproses, anda dapat melanjutkan unduh template setelah pembayaran disetujui admin';
            paymentMessage.style.display = 'block';

            // Show waiting section
            document.getElementById('qrSection').classList.remove('active');
            document.getElementById('waitingSection').classList.add('active');

            // Start polling payment status
            pollPaymentStatus();
        }).catch(err => {
            alert('Error creating payment: ' + err.message);
        });
        }

        // Poll payment status every 3 seconds
        function pollPaymentStatus() {
            if (!paymentId) return;

            fetch(`/api/payments/status/${paymentId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'approved' || data.status === 'confirmed') {
                    showSuccessSection();
                } else {
                    setTimeout(pollPaymentStatus, 3000);
                }
            }).catch(err => {
                console.error('Error polling payment status:', err);
                setTimeout(pollPaymentStatus, 5000);
            });
        }

        // Show success section with download button
        async function showSuccessSection() {
            document.getElementById('waitingSection').classList.remove('active');
            document.getElementById('successSection').classList.add('active');
            await displayDownloads();

            // Update sessionStorage with confirmed products for downloads page
            (async () => {
                const confirmedProducts = await Promise.all(cartItems.map(async (item) => {
                    const status = await fetchPaymentStatus(item.id);
                    return status === 'confirmed' || status === 'approved';
                }));
                const filteredProducts = cartItems.filter((_, index) => confirmedProducts[index]);
                sessionStorage.setItem('selectedTemplatesForDownload', JSON.stringify(filteredProducts));
            })();

            // Clear cart
            sessionStorage.removeItem('cart');
        }

        // Fetch payment status for each template
        async function fetchPaymentStatus(templateId) {
            try {
                const response = await fetch(`/api/payments`);
                if (!response.ok) {
                    throw new Error('Failed to fetch payments');
                }
                const payments = await response.json();
                const payment = payments.find(p => p.templateId === templateId && p.buyerEmail.toLowerCase() === currentUser.email.toLowerCase());
                return payment ? payment.status : 'pending';
            } catch (error) {
                console.error('Error fetching payment status:', error);
                return 'pending';
            }
        }

        // Display downloads with two buttons per template
async function displayDownloads() {
    const downloadList = document.getElementById('downloadList');
    downloadList.innerHTML = '';

    for (const template of cartItems) {
        const status = await fetchPaymentStatus(template.id);
        const isApproved = status === 'confirmed' || status === 'approved';

        const card = document.createElement('div');
        card.className = 'card mb-2';

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        const title = document.createElement('h5');
        title.className = 'card-title';
        title.textContent = template.title;

        // Add sample preview images container
        const previewContainer = document.createElement('div');
        previewContainer.style.display = 'flex';
        previewContainer.style.gap = '10px';
        previewContainer.style.marginBottom = '10px';
        previewContainer.style.justifyContent = 'center';
        previewContainer.style.overflow = 'hidden';

        if (template.samplePreviewUrls && template.samplePreviewUrls.length > 0) {
            template.samplePreviewUrls.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Sample Preview';
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.border = '1px solid #ccc';
                img.style.borderRadius = '4px';
                previewContainer.appendChild(img);
            });
        }

        cardBody.appendChild(previewContainer);

        const btnGreen = document.createElement('button');
        btnGreen.className = 'btn btn-download-green';
        btnGreen.textContent = 'Download';
        btnGreen.onclick = () => downloadTemplate(template.id);

        const btnRed = document.createElement('button');
        btnRed.className = 'btn btn-download-red';
        btnRed.textContent = 'Download';
        btnRed.onclick = () => alert('Pembayaran belum di-ACC oleh admin.');

        cardBody.appendChild(title);
        if (isApproved) {
            cardBody.appendChild(btnGreen);
        } else {
            cardBody.appendChild(btnRed);
        }
        card.appendChild(cardBody);
        downloadList.appendChild(card);
    }
}

        // Download template function updated to call backend download endpoint with buyer email
        function downloadTemplate(templateId) {
            const url = `/api/templates/${templateId}/download?email=${encodeURIComponent(currentUser.email)}`;
            window.location.href = url;
        }

        // Initialize page
        displayOrderSummary();

        // Add event listener for Pay Now button
        document.getElementById('payNowBtn').addEventListener('click', showQRCode);
    </script>
</body>
</html>
